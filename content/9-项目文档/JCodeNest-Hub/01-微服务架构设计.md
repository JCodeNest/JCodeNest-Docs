# 微服务架构设计

## 一、整体架构概览

```text
JCodeNest-Hub (父项目)
├── jcodenest-dependencies (统一版本管理)
├── jcodenest-framework (框架层 - 基础能力封装)
├── jcodenest-common (通用层)
├── jcodenest-gateway (统一网关)
├── jcodenest-auth (认证授权服务)
├── jcodenest-api (API接口模块)
├── jcodenest-platform (核心业务服务模块)
└── jcodenest-xxx (其他业务服务模块 - 灵活设计)
```

解决的核心问题：

1. **基础能力复用**: 通过 jcodenest-framework 层统一封装常用技术组件，避免各服务重复开发，提升开发效率。
2. **按需依赖**: 每个 Starter 模块独立设计，业务服务可选择性引入所需能力，减少不必要的依赖膨胀。
3. **版本统一**: jcodenest-dependencies 作为 BOM 模块，集中管理所有依赖版本，防止版本冲突并简化升级过程。
4. **开箱即用**: Starter 模块提供自动配置（AutoConfiguration）和默认属性（Properties），结合 Spring Boot 的约定大于配置原则，降低集成门槛。

---

扩展性设计：

- **新增基础能力**: 在 jcodenest-framework 中添加新的 Starter 模块（如 jcodenest-framework-starter-email），无需修改现有服务。
- **能力升级**: 统一升级 jcodenest-framework 版本，所有依赖的服务自动继承新功能，支持平滑迁移。
- **个性化配置**: 每个服务通过 application.yml 或 properties 文件覆盖默认配置，实现自定义行为（如调整缓存 TTL 或日志级别）。
- **模块热插拔**：支持动态添加业务模块（jcodenest-xxx），通过服务注册中心（如 Nacos）实现无缝集成。

---

治理能力：

- **统一标准**: 框架层强制技术规范和最佳实践（如统一异常处理和日志格式），确保代码一致性。
- **问题排查**: 集成链路追踪（Trace ID）、统一日志和监控，支持快速定位分布式系统中的问题。
- **安全管控**: 框架层内置安全策略（如 JWT 令牌验证和参数校验），结合 jcodenest-auth 服务实现全局访问控制。
- **性能优化**：支持多级缓存、异步处理和分布式锁，防范高并发场景下的瓶颈。

## 二、架构层设计

### 2.1 jcodenest-dependencies

`jcodenest-dependencies` 作为一个独立模块，不依赖于任何 `parent` 模块，仅用于管理版本依赖。这与 Spring Boot 中的 `spring-boot-starter-parent` 类似，
都是为了统一管理依赖版本。在 `jcodenest-dependencies` 中，专注于以下内容维护：

1. 定义项目中所有第三方依赖的版本，确保一致性。
2. 管理内部框架模块（`jcodenest-framework-starter-*`）的版本。
3. 作为 BOM 模块导入到父项目 JCodeNest-Hub 中，为所有子模块提供版本参考。

最后将其作为父项目 JCodeNest-Hub 的 BOM（Bill of Materials）模块， 为所有子项目提供版本管理。

只需要在父项目 JCodeNest-Hub 中将 `jcodenest-dependencies` 作为 BOM 引入即可:

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>cn.jcodenest.hub</groupId>
            <artifactId>jcodenest-dependencies</artifactId>
            <version>${revision}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

> ⚠️ 注意：父项目只需要维护该 BOM 即可，其他 BOM 例如 `spring-boot-dependencies` 、`spring-cloud-dependencies` 等，
> 都在 `jcodenest-dependencies` 的 `<dependencyManagement>` 中进行版本管理。

`jcodenest-dependencies` 维护的 BOM 示例如下:

```xml
<dependencyManagement>
    <dependencies>
        <!-- Spring Boot Dependencies -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>${spring-boot.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>

        <!-- Spring Cloud Dependencies -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring-cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>

        <!-- Spring Cloud Alibaba Dependencies -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>${spring-cloud-alibaba.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>

        <!-- Netty BOM -->
        <dependency>
            <groupId>io.netty</groupId>
            <artifactId>netty-bom</artifactId>
            <version>${netty.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>

        <!-- MyBatis Plus BOM -->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-bom</artifactId>
            <version>${mybatis-plus.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### 2.2 jcodenest-framework

`jcodenest-framework` 是框架核心层，封装各种基础技术能力，每个子模块以 Starter 形式设计，支持 Spring Boot 自动配置。模块间低耦合，便于独立维护和升级。

模块结构如下:

```text
jcodenest-framework
├── jcodenest-framework-starter-web          // Web基础能力
├── jcodenest-framework-starter-jdbc         // 数据库操作封装
├── jcodenest-framework-starter-redis        // Redis操作封装
├── jcodenest-framework-starter-file         // 文件处理封装
├── jcodenest-framework-starter-excel        // Excel处理封装
├── jcodenest-framework-starter-mq           // 消息队列封装
├── jcodenest-framework-starter-job          // 定时任务封装
├── jcodenest-framework-starter-log          // 日志处理封装
├── jcodenest-framework-starter-security     // 安全组件封装
├── jcodenest-framework-starter-cache        // 缓存封装
└── jcodenest-framework-starter-monitor      // 监控封装
```

#### 2.2.1 jcodenest-framework-starter-web

该模块提供 Web 层标准化能力，基于 Spring MVC，支持跨域、JSON 优化和请求追踪。

核心目标：统一 API 接口规范，提升开发一致性。

包路径设计:

```text
cn.jcodenest.framework.web
├── config             // 自动配置
│   ├── WebAutoConfiguration     // 启用 MVC、过滤器和拦截器
│   ├── CorsConfiguration        // 跨域配置，支持自定义域和方法
│   └── JacksonConfiguration     // JSON 序列化配置，处理日期和枚举
├── filter             // 过滤器
│   ├── RequestLogFilter         // 记录请求参数和响应时间
│   └── TraceIdFilter            // 生成和传播 Trace ID
├── interceptor        // 拦截器
│   └── ApiLogInterceptor        // 记录 API 调用日志
├── exception          // 异常处理
│   ├── GlobalExceptionHandler   // 系统异常统一响应
│   └── BusinessExceptionHandler // 业务异常自定义错误码
├── result             // 统一响应
│   ├── Result                   // 成功/失败包装
│   ├── PageResult               // 分页响应
│   └── ResultBuilder            // 构建器模式
├── validator          // 参数校验
│   ├── annotation               // 自定义注解（如 @PhoneNumber）
│   └── validator                // 实现类（如 PhoneNumberValidator）
└── properties         // 属性
    └── WebProperties            // 配置日志级别、跨域等
```

#### 2.2.2 jcodenest-framework-starter-jdbc

基于 Spring Boot JDBC 深度封装，支持参数化查询和编程式事务。不依赖 ORM（如 MyBatis），强调 `NamedParameterJdbcTemplate` 和
`DataSourceTransactionManager` 使用。

包路径设计:

```text
cn.jcodenest.framework.jdbc
├── config             // 自动配置
│   ├── DataSourceAutoConfiguration    // Druid/HikariCP 数据源
│   ├── JdbcTemplateAutoConfiguration  // 注入 NamedParameterJdbcTemplate
│   └── TransactionConfiguration       // 编程式事务管理
├── base              // CRUD 基础
│   ├── BaseDao                       // DAO 接口，使用参数源
│   ├── BaseEntity                    // 实体，支持 BeanPropertySqlParameterSource
│   └── BaseService                   // 服务，封装 CRUD 和事务
├── handler           // 处理器
│   ├── SqlParameterHandler           // 支持 MapSqlParameterSource 等
│   └── TransactionHandler            // 管理 TransactionStatus
├── page              // 分页
│   ├── PageHelper                    // LIMIT/OFFSET 支持
│   └── PageRequest                   // 请求对象
├── datasource        // 多数据源
│   ├── DynamicDataSource             // 路由器
│   └── DataSourceSelector            // 线程本地切换
└── properties        
    └── JdbcProperties                // 连接池和 SQL 日志配置
```

#### 2.2.3 jcodenest-framework-starter-redis

封装 Redis 底层操作，支持 Lettuce/Redisson 客户端。

重点：键值存储和分布式锁。区别于 cache 模块：此模块用于自定义 Redis 操作，非声明式缓存。

包路径设计:

```text
cn.jcodenest.framework.redis
├── config            // 自动配置
│   ├── RedisAutoConfiguration       // RedisTemplate 注入
│   └── CacheConfiguration           // 基础配置（不含注解）
├── service           // 服务
│   ├── RedisService                 // set/get/expire 等
│   ├── CacheService                 // 基本键值缓存
│   └── DistributedLockService       // 锁接口
├── lock             // 锁实现
│   ├── RedissonLock                 // 可重入锁
│   └── RedisLock                    // Lua 脚本锁
├── cache            // 基本增强
│   ├── annotation                   // 简单注解
│   └── aspect                       // 切面
└── properties
    └── RedisProperties              // 主机、端口配置
```

#### 2.2.4 jcodenest-framework-starter-file

支持多存储后端（如本地、MinIO、阿里 OSS），提供上传/下载和处理能力。确保文件安全（如签名 URL）和扩展性。

包路径设计:

```text
cn.jcodenest.framework.file
├── config           // 配置
│   └── FileAutoConfiguration       // 策略和服务注入
├── service          // 服务
│   ├── FileService                 // 操作接口
│   ├── UploadService               // 多部分上传
│   └── DownloadService             // 流式下载
├── storage          // 策略
│   ├── LocalStorage                // 本地存储
│   ├── OssStorage                  // 阿里 OSS
│   └── MinIOStorage                // MinIO
├── processor        // 处理器
│   ├── ImageProcessor              // 缩放/水印
│   └── DocumentProcessor           // PDF 转换
└── properties
    └── FileProperties              // 类型和路径配置
```

#### 2.2.5 jcodenest-framework-starter-excel

深度封装 EasyExcel，支持大文件导入/导出、注解映射和自定义样式。优化内存使用，集成错误校验。

包路径设计:

```text
cn.jcodenest.framework.excel
├── config           // 配置
│   └── ExcelAutoConfiguration      // 监听器注入
├── service          // 服务
│   ├── ExcelService                // 操作接口
│   ├── ImportService               // 批处理导入
│   └── ExportService               // 模板导出
├── listener         // 监听器
│   ├── ReadListener                // 行数据处理
│   └── WriteListener               // 样式合并
├── annotation       // 注解
│   ├── ExcelField                  // 字段标题/格式
│   └── ExcelSheet                  // 多 Sheet 支持
└── properties
    └── ExcelProperties             // 批大小配置
```

#### 2.2.6 jcodenest-framework-starter-mq

支持 RabbitMQ/RocketMQ/Kafka，提供生产/消费抽象。集成序列化、重试和延迟消息。

包路径设计:

```text
cn.jcodenest.framework.mq
├── config           // 配置
│   ├── RabbitMqAutoConfiguration   // 交换器配置
│   ├── RocketMqAutoConfiguration   // 主题配置
│   └── KafkaAutoConfiguration      // 分区配置
├── producer         // 生产者
│   ├── MessageProducer             // 同步/异步发送
│   └── DelayMessageProducer        // 延迟支持
├── consumer         // 消费者
│   ├── annotation                  // @MqListener
│   └── listener                    // 实现
├── serializer       // 序列化
│   └── MessageSerializer           // JSON/Protobuf
└── properties
    └── MqProperties                // 主机配置
```

#### 2.2.7 jcodenest-framework-starter-job

基于 XXL-JOB 的分布式调度，支持 Cron 和 API 触发。高可用性设计，集成监控。

包路径设计:

```text
cn.jcodenest.framework.job
├── config           // 配置
│   └── JobAutoConfiguration        // 执行器配置
├── executor         // 执行器
│   ├── JobExecutor                 // 接口
│   └── HandlerRegistry             // 注册
├── trigger          // 触发器
│   ├── CronTrigger                 // Cron 表达式
│   └── ApiTrigger                  // API 触发
├── monitor          // 监控
│   └── JobMonitor                  // 日志/状态
└── properties
    └── JobProperties               // 管理员地址
```

#### 2.2.8 jcodenest-framework-starter-log

基于 SLF4J/Logback，提供异步日志、MDC 和统一格式。支持链路追踪集成。

包路径设计:

```text
cn.jcodenest.framework.log
├── config           // 配置
│   └── LogAutoConfiguration        // Appender 注入
├── appender         // Appender
│   ├── FileAppender                // 轮转文件
│   └── ConsoleAppender             // 控制台
├── filter           // 过滤器
│   └── MdcFilter                   // MDC 支持 Trace ID
├── formatter        // 格式化
│   └── JsonFormatter               // JSON 格式
└── properties
    └── LogProperties               // 级别/路径
```

#### 2.2.9 jcodenest-framework-starter-security

基于 Sa-Token，提供 JWT 令牌、权限注解和会话管理。集成加密（如 Jasypt）。

包路径设计:

```text
cn.jcodenest.framework.security
├── config           // 配置
│   └── SecurityAutoConfiguration   // 拦截器注入
├── token            // 令牌
│   ├── TokenService                // 生成/验证
│   └── JwtTokenHandler             // JWT 处理
├── permission       // 权限
│   ├── annotation                  // @Permission
│   └── interceptor                 // 校验
├── session          // 会话
│   └── SessionManager              // 存储/过期
└── properties
    └── SecurityProperties          // 密钥/超时
```

#### 2.2.10 jcodenest-framework-starter-cache

提供注解式缓存（如 @Cacheable），支持多级（本地 + Redis）。区别于 redis：聚焦声明式，简化业务。

包路径设计:

```text
cn.jcodenest.framework.cache
├── config           // 配置
│   └── CacheAutoConfiguration      // 管理器注入
├── manager          // 管理器
│   ├── CacheManager                // 接口
│   └── MultiLevelCacheManager      // 多级支持
├── annotation       // 注解
│   ├── Cacheable                   // 缓存
│   └── CacheEvict                  // 驱逐
├── aspect           // 切面
│   └── CacheAspect                 // 实现
└── properties
    └── CacheProperties             // TTL/大小
```

#### 2.2.11 jcodenest-framework-starter-monitor

集成 Micrometer/Prometheus，支持指标、追踪和健康检查。便于集成 SkyWalking 等。

包路径设计:

```text
cn.jcodenest.framework.monitor
├── config           // 配置
│   └── MonitorAutoConfiguration    // 端点注入
├── metrics          // 指标
│   ├── CustomMetrics               // 注册
│   └── Exporter                    // Prometheus
├── trace            // 追踪
│   ├── SleuthIntegration           // Sleuth 集成
│   └── SpanHandler                 // Span 处理
├── health           // 健康
│   └── HealthIndicator             // 指示器
└── properties
    └── MonitorProperties           // 暴露端点
```

### 2.3 jcodenest-common

`jcodenest-common` 作为通用模块，编写业务相关的通用组件，依赖 framework 层。避免框架层污染业务逻辑。

模块结构:

```text
jcodenest-common
├── jcodenest-common-core       // 核心组件
├── jcodenest-common-auth       // 认证组件
├── jcodenest-common-api        // API 组件
└── jcodenest-common-biz        // 业务组件
```

包路径设计:

```text
cn.jcodenest.common
├── core
│   ├── constant       // 常量
│   │   └── AppConstants          // 状态码/键
│   ├── enums          // 枚举
│   │   └── StatusEnum            // ACTIVE 等
│   ├── context        // 上下文
│   │   └── ThreadContext         // 用户 ID 存储
│   └── utils          // 工具
│       ├── DateUtils             // 日期
│       └── StringUtils           // 字符串
├── auth
│   ├── model         // 模型
│   │   ├── UserAuth             // 用户信息
│   │   └── Role                 // 角色
│   ├── context       // 上下文
│   │   └── AuthContext          // 持有器
│   └── utils         // 工具
│       ├── PasswordUtils        // 加密
│       └── TokenUtils           // 解析
├── api
│   ├── model         // 模型
│   │   ├── RequestDto           // 请求 DTO
│   │   └── ResponseDto          // 响应 DTO
│   └── converter     // 转换器
│       ├── BeanConverter        // BeanUtils
│       └── MapStructConverter   // MapStruct
└── biz
    ├── model         // 模型
    │   ├── BaseBizEntity        // 基础实体
    │   └── WorkflowModel        // 工作流
    ├── service       // 服务
    │   ├── NotificationService  // 通知
    │   └── ValidationService    // 校验
    └── component     // 组件
        ├── EventPublisher       // 事件
        └── CacheComponent       // 缓存
```

## 三、依赖关系设计

依赖遵循最小化原则：业务模块依赖 common 和所需 Starter，framework Starter 间无交叉依赖。我们以 platform 微服务为例，见下图:

![依赖关系设计](https://jcodenest-oss.oss-cn-shanghai.aliyuncs.com/images/image-20250927133007845.png)